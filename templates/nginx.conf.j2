# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

{% set app = item %}
{% set app_dir = app.app_dir|default("/opt/%s/src" % item.name) %}
{% set run_dir = app.run_dir|default("/opt/%s/run" % item.name) %}
{% set log_dir = app.log_dir|default("/opt/%s/log" % item.name) %}
{% set socket = app.socket|default(run_dir + '/' + app.name) %}
{% set servernames = app.nginx_servernames|default(wsgi_nginx_servernames) %}
{% set port = app.nginx_port|default(wsgi_nginx_port) %}
{% set ssl = app.ssl|default(wsgi_nginx_ssl) -%}
{% set ssl_port = app.nginx_ssl_port|default(wsgi_nginx_ssl_port) %}
{% set ssl_redirect = app.nginx_ssl_redirect|default(wsgi_nginx_ssl_redirect) %}
{% set server = app.server|default(wsgi_server) -%}

{% macro server_init(port, ssl=False) -%}
server {
    listen {{port}};
{% if servernames %}
    server_name {{servernames}};
{% endif -%}

{% if ssl -%}
    ssl on;
    ssl_protocols   {{wsgi_nginx_ssl_protocols}};
    ssl_certificate {{app.nginx_ssl_crt|default(wsgi_nginx_ssl_crt)}};
    ssl_certificate_key {{app.nginx_ssl_key|default(wsgi_nginx_ssl_key)}};
{% endif %}

    access_log {{log_dir + '/' + app.name + '-nginx-access.log'}};
    error_log {{log_dir + '/' + app.name + '-nginx-error.log'}};

    charset utf-8;
    client_max_body_size 15M;
    expires off;
    gzip on;

    location / {
        expires off;

        {{ app.proxy_params|default(wsgi_proxy_params) }}

    {% if server == 'uwsgi' %}
        include uwsgi_params;
        uwsgi_pass wsgi-{{app.name}};
        uwsgi_read_timeout {{wsgi_uwsgi_read_timeout}};
    {% else %}
        proxy_pass http://wsgi-{{app.name}};
    {% endif %}
    }

{% for location in app.nginx_static_locations|default(wsgi_nginx_static_locations) %}
    location {{location}} {
        access_log off;
        root {{app.nginx_static_root|default(app_dir)}};
        expires max;
    }
{% endfor -%}

{% for option in app.nginx_options|default(wsgi_nginx_options) %}
    {{option}}
{% endfor -%}
}
{%- endmacro %}

# Application Upstream
upstream wsgi-{{app.name}} {
{% if socket.startswith('/') %}
  server unix://{{socket}};
{% elif socket.startswith(':') %}
  server localhost{{socket}};
{% else %}
  server {{socket}};
{% endif -%}
}

{% if wsgi_nginx_redirect_www -%}
# Rewrite www.domain.zone -> domain.zone
{% for sn in servernames.split(' ') %}
{% if sn.split('.')|length == 2 -%}
server {
    listen     {{port}};
    server_name www.{{sn}};
    rewrite ^(.*) $scheme://{{sn}}$1 permanent;
}
{% endif %}
{% endfor %}
{% endif %}

{% if ssl_redirect -%}
# Redirect HTTP to SSL
server {
    listen {{port}};
    server_name {{servernames}};
    rewrite ^(.*) https://$host$1 permanent;
}
{% else %}
# Server HTTP
{{ server_init(port) }}
{% endif %}

{% if ssl %}
# Server HTTPS
{{ server_init(ssl_port, ssl=True) }}
{% endif -%}

{{ app.nginx_raw|default('') }}
